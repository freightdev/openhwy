# docker-compose.production.yml
version: '3.8'

services:
    payment-service:
        image: your-registry.com/payment-service:latest
        ports:
            - '8080:8080'
        environment:
            - SERVER_HOST=0.0.0.0
            - SERVER_PORT=8080
            - DB_HOST=postgres
            - DB_PASSWORD_FILE=/run/secrets/db_password
            - JWT_SECRET_FILE=/run/secrets/jwt_secret
            - STRIPE_API_KEY_FILE=/run/secrets/stripe_api_key
            - REDIS_HOST=redis
            - LOG_LEVEL=info
            - TLS_ENABLED=true
            - TLS_CERT_FILE=/certs/tls.crt
            - TLS_KEY_FILE=/certs/tls.key
            - WEBHOOK_URL=https://your-app.com/webhooks/payments
        secrets:
            - db_password
            - jwt_secret
            - stripe_api_key
        volumes:
            - /etc/ssl/certs:/certs:ro
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - payment-network
        restart: unless-stopped
        deploy:
            replicas: 3
            update_config:
                parallelism: 1
                delay: 10s
                failure_action: rollback
            restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--no-verbose',
                    '--tries=1',
                    '--spider',
                    'http://localhost:8080/health',
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    postgres:
        image: postgres:15-alpine
        environment:
            POSTGRES_DB: payment_service
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD_FILE: /run/secrets/db_password
            POSTGRES_INITDB_ARGS: '--encoding=UTF8 --lc-collate=C --lc-ctype=C'
        secrets:
            - db_password
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./postgres-config/postgresql.conf:/etc/postgresql/postgresql.conf
            - ./postgres-config/pg_hba.conf:/etc/postgresql/pg_hba.conf
            - ./migrations:/docker-entrypoint-initdb.d
        command: |
            postgres
            -c shared_preload_libraries=pg_stat_statements
            -c config_file=/etc/postgresql/postgresql.conf
        ports:
            - '5432:5432'
        networks:
            - payment-network
        restart: unless-stopped
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U postgres']
            interval: 10s
            timeout: 5s
            retries: 5
        deploy:
            resources:
                limits:
                    memory: 2G
                    cpus: '1.0'
                reservations:
                    memory: 1G
                    cpus: '0.5'

    redis:
        image: redis:7-alpine
        command: |
            redis-server
            --appendonly yes
            --requirepass ${REDIS_PASSWORD:-secure_password}
            --maxmemory 512mb
            --maxmemory-policy allkeys-lru
            --tcp-keepalive 60
            --timeout 300
        ports:
            - '6379:6379'
        volumes:
            - redis_data:/data
            - ./redis-config/redis.conf:/etc/redis/redis.conf
        networks:
            - payment-network
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD',
                    'redis-cli',
                    '--no-auth-warning',
                    '-a',
                    '${REDIS_PASSWORD:-secure_password}',
                    'ping',
                ]
            interval: 10s
            timeout: 5s
            retries: 5
        deploy:
            resources:
                limits:
                    memory: 1G
                    cpus: '0.5'
                reservations:
                    memory: 512M
                    cpus: '0.25'

    # Load Balancer / Reverse Proxy
    nginx:
        image: nginx:alpine
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./nginx-config/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./nginx-config/default.conf:/etc/nginx/conf.d/default.conf:ro
            - ./ssl-certs:/etc/ssl/certs:ro
        depends_on:
            - payment-service
        networks:
            - payment-network
        restart: unless-stopped
        healthcheck:
            test: ['CMD', 'nginx', '-t']
            interval: 30s
            timeout: 10s
            retries: 3

    # Message Queue for async processing
    rabbitmq:
        image: rabbitmq:3.12-management-alpine
        hostname: rabbitmq
        ports:
            - '5672:5672'
            - '15672:15672' # Management UI
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-payment_user}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-payment_pass}
            RABBITMQ_DEFAULT_VHOST: payment_vhost
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
            - ./rabbitmq-config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
            - ./rabbitmq-config/definitions.json:/etc/rabbitmq/definitions.json
        networks:
            - payment-network
        restart: unless-stopped
        healthcheck:
            test: ['CMD', 'rabbitmq-diagnostics', 'ping']
            interval: 30s
            timeout: 10s
            retries: 3

    # Monitoring Stack
    prometheus:
        image: prom/prometheus:latest
        ports:
            - '9090:9090'
        volumes:
            - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - ./monitoring/rules:/etc/prometheus/rules:ro
            - prometheus_data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--storage.tsdb.retention.time=30d'
            - '--web.enable-lifecycle'
        networks:
            - payment-network
        restart: unless-stopped
        depends_on:
            - payment-service

    grafana:
        image: grafana/grafana:latest
        ports:
            - '3000:3000'
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
            - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
        volumes:
            - grafana_data:/var/lib/grafana
            - ./monitoring/grafana-dashboards:/etc/grafana/provisioning/dashboards
            - ./monitoring/grafana-datasources:/etc/grafana/provisioning/datasources
        networks:
            - payment-network
        restart: unless-stopped
        depends_on:
            - prometheus

    alertmanager:
        image: prom/alertmanager:latest
        ports:
            - '9093:9093'
        volumes:
            - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
            - alertmanager_data:/alertmanager
        command:
            - '--config.file=/etc/alertmanager/alertmanager.yml'
            - '--storage.path=/alertmanager'
            - '--web.external-url=http://localhost:9093'
        networks:
            - payment-network
        restart: unless-stopped

    # Log aggregation
    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        environment:
            - discovery.type=single-node
            - xpack.security.enabled=false
            - 'ES_JAVA_OPTS=-Xms1g -Xmx1g'
        ports:
            - '9200:9200'
        volumes:
            - elasticsearch_data:/usr/share/elasticsearch/data
        networks:
            - payment-network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 1G

    kibana:
        image: docker.elastic.co/kibana/kibana:8.11.0
        ports:
            - '5601:5601'
        environment:
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        depends_on:
            - elasticsearch
        networks:
            - payment-network
        restart: unless-stopped

    logstash:
        image: docker.elastic.co/logstash/logstash:8.11.0
        volumes:
            - ./logging/logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro
        ports:
            - '5044:5044'
        depends_on:
            - elasticsearch
        networks:
            - payment-network
        restart: unless-stopped

    # Database backup service
    pg-backup:
        image: prodrigestivill/postgres-backup-local
        environment:
            - POSTGRES_HOST=postgres
            - POSTGRES_DB=payment_service
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
            - BACKUP_KEEP_DAYS=7
            - BACKUP_KEEP_WEEKS=4
            - BACKUP_KEEP_MONTHS=6
            - HEALTHCHECK_PORT=8080
        secrets:
            - db_password
        volumes:
            - ./backups:/backups
        networks:
            - payment-network
        restart: unless-stopped
        depends_on:
            - postgres

secrets:
    db_password:
        file: ./secrets/db_password.txt
    jwt_secret:
        file: ./secrets/jwt_secret.txt
    stripe_api_key:
        file: ./secrets/stripe_api_key.txt

volumes:
    postgres_data:
        driver: local
    redis_data:
        driver: local
    prometheus_data:
        driver: local
    grafana_data:
        driver: local
    alertmanager_data:
        driver: local
    elasticsearch_data:
        driver: local
    rabbitmq_data:
        driver: local

networks:
    payment-network:
        driver: bridge
        driver_opts:
            com.docker.network.bridge.name: payment-bridge
        ipam:
            config:
                - subnet: 172.20.0.0/16

---

